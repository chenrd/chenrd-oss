<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:jbpm="http://drools.org/schema/drools-spring"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
                           http://drools.org/schema/drools-spring http://drools.org/schema/drools-spring-1.3.0.xsd">

	<bean id="jbpmDataSource" class="com.atomikos.jdbc.AtomikosDataSourceBean" init-method="init" destroy-method="close"> 
		<property name="uniqueResourceName" value="jbpmDS" /> 
		<property name="xaDataSourceClassName" value="${default.jdbc.driver}" /> 
		<property name="xaProperties"> 
			<props> 
				<prop key="user">${jbpm.jdbc.username}</prop> 
				<prop key="password">${jbpm.jdbc.password}</prop> 
				<prop key="URL">${jbpm.jdbc.url}</prop> 
			</props> 
		</property> 
		<property name="poolSize" value="${jbpm.jdbc.poolSize}" /> 
		<property name="minPoolSize" value="${jbpm.jdbc.minPoolSize}" /> 
		<property name="maxPoolSize" value="${jbpm.jdbc.maxPoolSize}" /> 
		<property name="testQuery" value="${jbpm.jdbc.testQuery}" /> 
	</bean>

  <bean id="jbpmEMF" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
    <property name="dataSource" ref="jbpmDataSource" />
    <property name="persistenceUnitName" value="org.jbpm.persistence.jpa"/>
  </bean>


  <bean id="jbpmTxManager" class="org.springframework.orm.jpa.JpaTransactionManager">
    <property name="entityManagerFactory" ref="jbpmEMF"/>
    <property name="nestedTransactionAllowed" value="false"/>
  </bean>
  
<!--   <bean id="humanTaskServer" class="com.chenrd.workflow.taskService.HumanTaskServer">
  	<property name="address"><value>${workflow.taskService.address}</value></property>
  	<property name="port"><value>${workflow.taskService.port}</value></property>
  	<property name="jbpmEMF" ref="jbpmEMF" />
  	<property name="taskService" ref="internalTaskService"/>
  </bean> -->

<!--   <jbpm:kbase id="kbase1">
    <jbpm:resources>
      <jbpm:resource type="BPMN2" source="classpath:bpmn/leave.bpmn"/>
    </jbpm:resources>
  </jbpm:kbase>

  <jbpm:ksession id="ksession1" type="stateful" kbase="kbase1">
    <jbpm:configuration>
      <jbpm:jpa-persistence>
        <jbpm:transaction-manager ref="jbpmTxManager"/>
        <jbpm:entity-manager-factory ref="jbpmEMF"/>
      </jbpm:jpa-persistence>
    </jbpm:configuration>
  </jbpm:ksession> -->
  
  
<bean id="systemEventListener" class="org.drools.SystemEventListenerFactory" factory-method="getSystemEventListener" />

<bean id="internalTaskService" class="org.jbpm.task.service.TaskService" >
  <property name="systemEventListener" ref="systemEventListener" />
</bean>

<bean id="htTxManager" class="org.drools.container.spring.beans.persistence.HumanTaskSpringTransactionManager">
  <constructor-arg ref="jbpmTxManager" />
</bean>

<bean id="springTaskSessionFactory" class="org.jbpm.task.service.persistence.TaskSessionSpringFactoryImpl"
      init-method="initialize" depends-on="internalTaskService" >
  <property name="entityManagerFactory" ref="jbpmEMF" />
  <property name="transactionManager" ref="htTxManager" />
  <property name="useJTA" value="true" />
  <property name="taskService" ref="internalTaskService" />
</bean>

<bean id="taskService" class="org.jbpm.task.service.local.LocalTaskService" depends-on="springTaskSessionFactory" >
  <constructor-arg ref="internalTaskService" />
</bean>
  
<bean id="workflowInti" class="com.chenrd.oa.workflow.init.WorkflowInti" init-method="init">
	<property name="internalTaskService" ref="internalTaskService"/>
	<property name="organizationService" ref="organizationService"/>
	<property name="userService" ref="userService"/>
</bean>
</beans>
